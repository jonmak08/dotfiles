#!/bin/bash

# Dotfiles Installation Script
# Usage: ./install [options]

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Configuration
DRY_RUN=false
VERBOSE=false
SKIP_MODULES=()
ONLY_MODULES=()

# Available modules
MODULES=(
  "homebrew"
  "editorconfig"
  "bash"
  "oh-my-zsh"
  "git"
  "karabiner"
  "mackup"
  "macos"
)

# Print colored output
print_color() {
  local color=$1
  shift
  echo -e "${color}$@${NC}"
}

print_success() { print_color "$GREEN" "âœ“ $@"; }
print_error() { print_color "$RED" "âœ— $@"; }
print_warning() { print_color "$YELLOW" "âš  $@"; }
print_info() { print_color "$CYAN" "â„¹ $@"; }
print_step() { print_color "$MAGENTA" "â†’ $@"; }

# Usage information
usage() {
  cat << EOF
Dotfiles Installation Script

Usage: ./install [options]

Options:
  -h, --help              Show this help message
  -d, --dry-run           Show what would be done without making changes
  -v, --verbose           Enable verbose output
  -s, --skip MODULE       Skip a specific module (can be used multiple times)
  -o, --only MODULE       Only install specific module (can be used multiple times)
  -l, --list              List available modules

Available modules:
$(printf "  - %s\n" "${MODULES[@]}")

Examples:
  ./install                           # Install everything
  ./install --dry-run                 # Show what would be installed
  ./install --skip macos              # Install everything except macOS settings
  ./install --only git --only bash    # Only install git and bash
  ./install -v                        # Verbose output

EOF
  exit 0
}

# List modules
list_modules() {
  print_info "Available modules:"
  for module in "${MODULES[@]}"; do
    echo "  - $module"
  done
  exit 0
}

# Check if module should be skipped
should_skip_module() {
  local module=$1

  # If ONLY_MODULES is set, skip anything not in the list
  if [ ${#ONLY_MODULES[@]} -gt 0 ]; then
    for only_module in "${ONLY_MODULES[@]}"; do
      if [ "$module" = "$only_module" ]; then
        return 1  # Don't skip
      fi
    done
    return 0  # Skip
  fi

  # Check if module is in SKIP_MODULES
  for skip_module in "${SKIP_MODULES[@]}"; do
    if [ "$module" = "$skip_module" ]; then
      return 0  # Skip
    fi
  done

  return 1  # Don't skip
}

# Run a setup script
run_setup() {
  local module=$1
  local setup_script="./${module}/setup.sh"

  if should_skip_module "$module"; then
    print_warning "Skipping $module"
    return 0
  fi

  if [ ! -f "$setup_script" ]; then
    print_warning "Setup script not found: $setup_script"
    return 0
  fi

  print_step "Setting up $module..."

  if [ "$DRY_RUN" = true ]; then
    print_info "[DRY RUN] Would execute: $setup_script"
  else
    if [ "$VERBOSE" = true ]; then
      bash "$setup_script"
    else
      bash "$setup_script" > /dev/null 2>&1
    fi

    if [ $? -eq 0 ]; then
      print_success "$module setup complete"
    else
      print_error "$module setup failed"
      exit 1
    fi
  fi
}

# Check prerequisites
check_prerequisites() {
  print_step "Checking prerequisites..."

  # Check if running on macOS
  if [[ "$OSTYPE" != "darwin"* ]]; then
    print_error "This script is designed for macOS only"
    exit 1
  fi

  print_success "Running on macOS"

  # Check if running from the dotfiles directory
  if [ ! -f "./setup.sh" ]; then
    print_error "Please run this script from the dotfiles directory"
    exit 1
  fi

  print_success "Running from dotfiles directory"

  # Check internet connection (needed for Homebrew, etc.)
  if ! ping -c 1 github.com &> /dev/null; then
    print_warning "No internet connection detected. Some installations may fail."
  else
    print_success "Internet connection available"
  fi
}

# Parse command line arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    -h|--help)
      usage
      ;;
    -d|--dry-run)
      DRY_RUN=true
      shift
      ;;
    -v|--verbose)
      VERBOSE=true
      shift
      ;;
    -s|--skip)
      SKIP_MODULES+=("$2")
      shift 2
      ;;
    -o|--only)
      ONLY_MODULES+=("$2")
      shift 2
      ;;
    -l|--list)
      list_modules
      ;;
    *)
      print_error "Unknown option: $1"
      echo ""
      usage
      ;;
  esac
done

# Main installation
main() {
  # Clear screen if running in a terminal
  [ -t 1 ] && clear

  print_color "$CYAN" "=================================="
  print_color "$CYAN" "  Dotfiles Installation Script"
  print_color "$CYAN" "=================================="
  echo ""

  if [ "$DRY_RUN" = true ]; then
    print_warning "DRY RUN MODE - No changes will be made"
    echo ""
  fi

  # Check prerequisites
  check_prerequisites
  echo ""

  # Show what will be installed
  print_info "Installation plan:"
  for module in "${MODULES[@]}"; do
    if should_skip_module "$module"; then
      echo "  [ ] $module (skipped)"
    else
      echo "  [x] $module"
    fi
  done
  echo ""

  # Confirm installation (skip in dry-run mode)
  if [ "$DRY_RUN" = false ]; then
    read -p "Continue with installation? (y/n) " -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
      print_warning "Installation cancelled"
      exit 0
    fi
    echo ""
  fi

  # Run setup for each module
  for module in "${MODULES[@]}"; do
    run_setup "$module"
  done

  echo ""
  print_color "$GREEN" "=================================="
  print_color "$GREEN" "  Installation Complete! ðŸŽ‰"
  print_color "$GREEN" "=================================="
  echo ""
  print_info "You may need to restart your terminal for all changes to take effect."
  echo ""
}

main

